stages:
    - preparation
    - testing
    - security
    - deploy

# Variables
variables:
    POSTGRES_DB: asanato_test
    POSTGRES_USER: postgres
    POSTGRES_PASSWORD: nxRN5q8AJxadtGvX
    POSTGRES_HOST_AUTH_METHOD: trust
    POSTGRES_INITDB_ARGS: "--encoding=UTF8 --data-checksums"
    APP_HOST_NAME: asanpay.local
    API_HOST_NAME: api.asanpay.local
    DB_HOST: postgres

image: edbizarro/gitlab-ci-pipeline-php:7.4

.init_ssh: &init_ssh |
    eval $(ssh-agent -s)
    echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add - > /dev/null
    mkdir -p ~/.ssh
    chmod 700 ~/.ssh
    [[ -f /.dockerenv ]] && echo -e "Host *\n\tStrictHostKeyChecking no\n\n" > ~/.ssh/config

    # Replace the last line with the following lines if you'd rather
    # leave StrictHostKeyChecking enabled (replace yourdomain.com):
    #
    #  ssh-keyscan yourdomain.com >> ~/.ssh/known_hosts
    #  chmod 644 ~/.ssh/known_hosts

.change_file_permissions: &change_file_permissions |
    find . -type f -not -path "./vendor/*" -exec chmod 664 {} \;
    find . -type d -not -path "./vendor/*" -exec chmod 775 {} \;


cache:
    key: "$CI_JOB_NAME-$CI_COMMIT_REF_SLUG"

composer:
    stage: preparation
    allow_failure: true
    script:
        - php -v
        - composer install --prefer-dist --no-ansi --no-interaction --no-progress --no-scripts
        - cp .env.example .env
        - php artisan key:generate --env=testing
        - php artisan apiato
    artifacts:
        paths:
            - vendor/
            - .env
        expire_in: 1 days
    cache:
        paths:
            - vendor/
    when: always

yarn:
    stage: preparation
    script:
        - yarn --version
        - yarn install --pure-lockfile
        - yarn run production --progress false
    artifacts:
        paths:
            - node_modules/
        expire_in: 1 days
    cache:
        paths:
            - public/css/
            - public/js/
            - public/fonts/
            - public/mix-manifest.json
    when: always

phpunit:
    stage: testing
    services:
        -   name: aboozar/postgres:latest
            alias: postgres
    dependencies:
        - composer
    allow_failure: true
    script:
        - php artisan migrate:fresh --no-interaction --env=testing
        - php artisan apiato:seed-deploy --no-interaction --env=testing
        - php artisan apiato:seed-test --no-interaction --env=testing
        - sudo -- sh -c -e "echo '127.0.0.1 $APP_HOST_NAME' >> /etc/hosts"
        - sudo -- sh -c -e "echo '127.0.0.1 $API_HOST_NAME' >> /etc/hosts"
        - cat /etc/hosts
        - sudo php artisan serve --host=api.asanpay.local --port=80 &
        - php vendor/bin/phpunit -v --coverage-text --colors=never --stderr
    artifacts:
        paths:
            - ./storage/logs # for debugging
        expire_in: 1 days
    when: always

syntax-check:
    stage: testing
    dependencies:
        - composer
    script:
        - php vendor/bin/phplint

codestyle:
    stage: testing
    dependencies:
        - composer
    script:
        - php vendor/bin/phpcs

phpcpd:
    stage: testing
    script:
        - test -f phpcpd.phar || curl -L https://phar.phpunit.de/phpcpd.phar -o phpcpd.phar
        - php phpcpd.phar app
    cache:
        paths:
            - phpcpd.phar
    when: always

sensiolabs:
    stage: security
    script:
        - test -d security-checker || git clone https://github.com/sensiolabs/security-checker.git
        - cd security-checker
        - composer install
        - php security-checker security:check ../composer.lock
    dependencies:
        - composer
    cache:
        paths:
            - security-checker/
    when: always

staging:
    stage: deploy
    script:
        - *init_ssh
        - *change_file_permissions
        - php artisan deploy asanato.ir -s upload
    environment:
        name: staging
        url: https://api.asanato.ir
    only:
        - staging
    when: manual

production:
    stage: deploy
    script:
        - *init_ssh
        - *change_file_permissions
        - php artisan deploy asanpay.com -s upload
    environment:
        name: production
        url: https://api.asanpay.com
    when: manual
    only:
        - master
        - production
